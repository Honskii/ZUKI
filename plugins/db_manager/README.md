# db_manager

`db_manager` — плагин для работы с базой данных и транзакциями.
Предоставляет асинхронный `engine`, `UnitOfWork` и базовые инструменты
для интеграции SQLAlchemy в плагины и хэндлеры.

---

## Конфигурация

Плагин использует `config.toml`.

Пример секции подключения:

```toml
[database]
driver = "postgresql+asyncpg"
user = "user"
password = "password"
host = "localhost"
port = 5432
database = "app_db"
````

Формат зависит от SQLAlchemy и выбранного драйвера.

---

## Engine

При загрузке плагин создаёт асинхронный SQLAlchemy `engine`
и регистрирует его как сервис приложения: `db_manager:engine`

`engine` может использоваться плагинами напрямую
для выполнения запросов и интеграции с другими инструментами.

---

## Unit of Work

`db_manager` предоставляет реализацию `UnitOfWork`
для управления транзакциями через асинхронный контекстный менеджер.

Поведение:

* создаёт сессию
* выполняет `commit` при успешном завершении блока
* выполняет `rollback` при ошибке
* закрывает сессию при выходе

Пример:

````python
async with UnitOfWork(engine) as uow:
    await uow.session.execute(...)
````

---

## Middleware

Плагин регистрирует middleware,
которое передаёт `uow_factory` через `dispatcher.update.middleware`.

Хэндлеры и плагины самостоятельно решают,
когда и как использовать `UnitOfWork`.

---

## Модели

Плагин предоставляет декларативный `Base`,
который может использоваться для описания моделей.

Создание таблиц возможно при старте приложения,
если это включено в конфигурации.

---

## Соглашение

Рекомендуемое соглашение именовании таблиц:

````python
__tablename__ = "plugin_name__table_name"
````

Пример:

````python
__tablename__ = "db_manager__users"
````

---

## Жизненный цикл

При загрузке создаёт все необходимые сервисы, подключает middleware, который передаёт `uow_factory`, объект `db_manager.UnitOfWork`
При старте плагин создаёт все ещё несуществующие таблицы, модели которых наследовались от `db_manager.Base`, инициализирует подключение к базе данных.
При завершении работы освобождает ресурсы.

---

## Использование

1. Подключите плагин.
2. Настройте `config.toml`.
3. Получайте сервис `db_manager:engine` или фабрику `uow_factory` в middleware/handler там, где это необходимо.
4. Работайте с транзакциями через `UnitOfWork`.

```
